# Toolbox image: ghcr.io/wycats/bootc-toolbox
#
# This is the development environment container. It's ephemeral â€” rebuild and
# recreate as needed. $HOME persists on the host.
#
# Key design principles:
# - PATH set via container labels (works regardless of how you enter)
# - ~/.local/toolbox/bin for toolbox-specific scripts (in PATH)
# - VS Code attaches from host via Remote - Containers
# - GPG signing works via gpg-agent forwarding
#
# Toolchain philosophy:
# - Toolchain INSTALLERS (rustup, proto) are baked into this image
# - Toolchain STATE (~/.rustup, ~/.cargo, ~/.proto) lives in user's home
# - Init hooks bring toolchains up to date (rustup update, proto install)
#
# TODO: This Containerfile should eventually be manifest-driven like the main
# Containerfile, with managed sections generated by `bkt containerfile`.
# See docs/VISION.md for details.

FROM registry.fedoraproject.org/fedora-toolbox:42

# Basic dev tools (packages available in Fedora repos)
RUN dnf install -y \
    gh \
    jq \
    ripgrep \
    fd-find \
    fzf \
    bat \
    zoxide \
    ShellCheck \
    python3 \
    python3-pip \
    nodejs \
    npm \
    unzip \
    && dnf clean all

# Starship and eza: download from GitHub releases (not in Fedora repos, COPR lacks F42)
RUN curl -fsSL https://github.com/starship/starship/releases/latest/download/starship-x86_64-unknown-linux-gnu.tar.gz \
    | tar xz -C /usr/local/bin starship \
    && curl -fsSL https://github.com/eza-community/eza/releases/latest/download/eza_x86_64-unknown-linux-gnu.tar.gz \
    | tar xz --strip-components=0 -C /usr/local/bin

# Rust toolchain support (actual toolchain lives in ~/.cargo)
RUN dnf install -y \
    gcc \
    gcc-c++ \
    make \
    cmake \
    pkg-config \
    openssl-devel \
    && dnf clean all

# Toolchain installers: rustup and proto
# These binaries are installed system-wide; toolchain state lives in $HOME
# Environment variables ensure toolchains install to user's home at runtime
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs \
    | sh -s -- -y --no-modify-path --default-toolchain none \
    && mv /root/.cargo/bin/rustup /usr/local/bin/rustup \
    && rm -rf /root/.cargo /root/.rustup

RUN curl -fsSL https://moonrepo.dev/install/proto.sh \
    | bash -s -- --yes --no-profile \
    && mv /root/.proto/bin/proto /usr/local/bin/proto \
    && rm -rf /root/.proto

# GPG support for git commit signing
RUN dnf install -y \
    gnupg2 \
    pinentry-gnome3 \
    && dnf clean all

# Nushell: not in Fedora 42 repos, download latest from GitHub releases
# Uses jq to get latest version, then extracts binaries dynamically
RUN set -eu; \
    version=$(curl -fsSL https://api.github.com/repos/nushell/nushell/releases/latest | grep -oP '"tag_name": "\K[^"]+'); \
    asset="nu-${version}-x86_64-unknown-linux-gnu.tar.gz"; \
    dir="nu-${version}-x86_64-unknown-linux-gnu"; \
    curl -fsSL "https://github.com/nushell/nushell/releases/download/${version}/${asset}" \
        | tar xz --strip-components=1 -C /usr/local/bin \
            "${dir}/nu" \
            "${dir}/nu_plugin_query" \
            "${dir}/nu_plugin_polars" \
            "${dir}/nu_plugin_formats" \
            "${dir}/nu_plugin_gstat"

# Set PATH via container labels so it works regardless of entry method
# This is read by toolbox/podman and prepended to PATH
LABEL com.github.containers.toolbox="true"

# Additional PATH entries for user-installed toolchains
# Note: In toolbox, $HOME is bind-mounted from host, so username matches host user
# Using ARG with default for build-time, but at runtime toolbox handles this
# Order: custom scripts > host shims > toolchains > proto shims
ARG USERNAME=wycats
ENV PATH="/home/${USERNAME}/.local/bin:/home/${USERNAME}/.local/toolbox/bin:/home/${USERNAME}/.local/toolbox/shims:/home/${USERNAME}/.nix-profile/bin:/home/${USERNAME}/.cargo/bin:/home/${USERNAME}/.proto/bin:/home/${USERNAME}/.proto/shims:${PATH}"

# Default shell
ENV SHELL=/usr/bin/bash
