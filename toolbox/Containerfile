# Toolbox image: ghcr.io/wycats/bootc-toolbox
#
# This is the development environment container. It's ephemeral â€” rebuild and
# recreate as needed. $HOME persists on the host.
#
# Key design principles:
# - PATH set via container labels (works regardless of how you enter)
# - ~/.local/toolbox/bin for toolbox-specific scripts (in PATH)
# - VS Code attaches from host via Remote - Containers
# - GPG signing works via gpg-agent forwarding

FROM registry.fedoraproject.org/fedora-toolbox:42

# Basic dev tools (packages available in Fedora repos)
RUN dnf install -y \
    gh \
    jq \
    ripgrep \
    fd-find \
    fzf \
    bat \
    zoxide \
    ShellCheck \
    python3 \
    python3-pip \
    nodejs \
    npm \
    && dnf clean all

# Starship and eza: download from GitHub releases (not in Fedora repos, COPR lacks F42)
RUN curl -fsSL https://github.com/starship/starship/releases/latest/download/starship-x86_64-unknown-linux-gnu.tar.gz \
    | tar xz -C /usr/local/bin starship \
    && curl -fsSL https://github.com/eza-community/eza/releases/latest/download/eza_x86_64-unknown-linux-gnu.tar.gz \
    | tar xz --strip-components=0 -C /usr/local/bin

# Rust toolchain support (actual toolchain lives in ~/.cargo)
RUN dnf install -y \
    gcc \
    gcc-c++ \
    make \
    cmake \
    pkg-config \
    openssl-devel \
    && dnf clean all

# GPG support for git commit signing
RUN dnf install -y \
    gnupg2 \
    pinentry-gnome3 \
    && dnf clean all

# Nushell: not in Fedora 42 repos, download from GitHub releases
RUN curl -fsSL https://github.com/nushell/nushell/releases/latest/download/nu-0.109.1-x86_64-unknown-linux-gnu.tar.gz \
    | tar xz --strip-components=1 -C /usr/local/bin \
        nu-0.109.1-x86_64-unknown-linux-gnu/nu \
        nu-0.109.1-x86_64-unknown-linux-gnu/nu_plugin_query \
        nu-0.109.1-x86_64-unknown-linux-gnu/nu_plugin_polars \
        nu-0.109.1-x86_64-unknown-linux-gnu/nu_plugin_formats \
        nu-0.109.1-x86_64-unknown-linux-gnu/nu_plugin_gstat

# Set PATH via container labels so it works regardless of entry method
# This is read by toolbox/podman and prepended to PATH
LABEL com.github.containers.toolbox="true"

# Additional PATH entries for user-installed toolchains
# Note: In toolbox, $HOME is bind-mounted from host, so username matches host user
# Using ARG with default for build-time, but at runtime toolbox handles this
# Order: custom scripts > host shims > toolchains
ARG USERNAME=wycats
ENV PATH="/home/${USERNAME}/.local/bin:/home/${USERNAME}/.local/toolbox/bin:/home/${USERNAME}/.local/toolbox/shims:/home/${USERNAME}/.nix-profile/bin:/home/${USERNAME}/.cargo/bin:/home/${USERNAME}/.proto/bin:${PATH}"

# Default shell
ENV SHELL=/usr/bin/bash
