// bkt admin: Passwordless privileged operations for wheel group
// 
// This polkit rule grants wheel group members passwordless access to
// bootc, rpm-ostree, and flatpak commands when invoked via pkexec.
//
// Security rationale:
// - Wheel group already has sudo access; this adds no new privilege
// - Polkit provides audit logging
// - bkt's --confirm flag prevents accidental mutations
// - Follows the "you're maintaining your own distribution" philosophy
//
// IMPORTANT LIMITATION:
// This rule grants access to ALL bootc/rpm-ostree/flatpak subcommands
// via pkexec. Users can bypass bkt's --confirm safety by running
// `pkexec bootc upgrade` directly. This is intentional: wheel users
// already have root access via sudo, so the polkit rule doesn't grant
// new capabilities—it just makes authorized operations more convenient.
//
// For the safety of the --confirm flag, always use `bkt admin bootc <cmd>`
// rather than invoking pkexec directly.
//
// The flatpak rule is critical for bootc-bootstrap: the script runs as a
// systemd user oneshot during login and uses `pkexec flatpak` for
// system-scope remote and app management. Without this rule, each
// pkexec call triggers an interactive polkit auth dialog — and with
// 70+ system-scope flatpak operations, that means 70+ prompts firing
// before the user even reaches their desktop.
//
// Installed by: Containerfile
// See: docs/rfcs/0009-privileged-operations.md

polkit.addRule(function(action, subject) {
    // Only handle pkexec (org.freedesktop.policykit.exec) actions
    if (action.id !== "org.freedesktop.policykit.exec") {
        return polkit.Result.NOT_HANDLED;
    }

    // Only grant to wheel group members
    if (!subject.isInGroup("wheel")) {
        return polkit.Result.NOT_HANDLED;
    }

    // Get the program being executed
    var program = action.lookup("program");

    // Allow bootc commands (image management)
    if (program === "/usr/bin/bootc") {
        return polkit.Result.YES;
    }

    // Allow rpm-ostree commands (legacy/fallback)
    if (program === "/usr/bin/rpm-ostree") {
        return polkit.Result.YES;
    }

    // Allow flatpak commands (system-scope app/remote management)
    // Used by bootc-bootstrap for declarative flatpak provisioning
    if (program === "/usr/bin/flatpak") {
        return polkit.Result.YES;
    }

    // Don't handle other programs
    return polkit.Result.NOT_HANDLED;
});
