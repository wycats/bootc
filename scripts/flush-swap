#!/bin/bash
# flush-swap: Safely migrate swapped pages back to RAM
#
# The kernel has no "swap-in all" API. The only way to force swap-in is
# `swapoff`, which fails if there isn't enough free RAM to absorb the
# swapped pages. This script checks headroom and drops caches if needed.
#
# Usage: sudo flush-swap [--force]
#   --force: Skip confirmation prompt

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info()  { echo -e "${BLUE}[INFO]${NC} $*"; }
log_warn()  { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_ok()    { echo -e "${GREEN}[OK]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*" >&2; }

# Parse memory info (in kB)
get_mem_kb() {
    awk -v key="$1" '$1 == key ":" { print $2 }' /proc/meminfo
}

human_size() {
    local kb=$1
    if (( kb >= 1048576 )); then
        echo "$(( kb / 1048576 ))G"
    elif (( kb >= 1024 )); then
        echo "$(( kb / 1024 ))M"
    else
        echo "${kb}K"
    fi
}

show_status() {
    local mem_total mem_available swap_total swap_used swap_free
    mem_total=$(get_mem_kb MemTotal)
    mem_available=$(get_mem_kb MemAvailable)
    swap_total=$(get_mem_kb SwapTotal)
    swap_free=$(get_mem_kb SwapFree)
    swap_used=$(( swap_total - swap_free ))

    echo "Memory:  $(human_size "$mem_available") available / $(human_size "$mem_total") total"
    echo "Swap:    $(human_size "$swap_used") used / $(human_size "$swap_total") total"
}

main() {
    local force=false
    [[ "${1:-}" == "--force" ]] && force=true

    # Must be root
    if [[ $EUID -ne 0 ]]; then
        log_error "This script must be run as root (sudo flush-swap)"
        exit 1
    fi

    # Check if swap is even in use
    local swap_total swap_free swap_used
    swap_total=$(get_mem_kb SwapTotal)
    swap_free=$(get_mem_kb SwapFree)
    swap_used=$(( swap_total - swap_free ))

    if (( swap_used < 1024 )); then
        log_ok "Swap is already empty (< 1MB used)"
        show_status
        exit 0
    fi

    log_info "Current state:"
    show_status
    echo

    # Check if we have enough headroom
    local mem_available reclaimable headroom needed_headroom
    mem_available=$(get_mem_kb MemAvailable)
    reclaimable=$(get_mem_kb SReclaimable)
    headroom=$(( mem_available + reclaimable ))
    needed_headroom=$(( swap_used + 524288 ))  # swap_used + 512MB safety margin

    local need_cache_drop=false
    if (( headroom < needed_headroom )); then
        need_cache_drop=true
        log_warn "Insufficient headroom: $(human_size "$headroom") available, need ~$(human_size "$needed_headroom")"
        log_warn "Will drop caches first to free RAM"
    else
        log_ok "Sufficient headroom: $(human_size "$headroom") available for $(human_size "$swap_used") swap"
    fi

    # Confirm unless --force
    if [[ "$force" != true ]]; then
        echo
        if $need_cache_drop; then
            echo -e "${YELLOW}This will drop filesystem caches, which may cause temporary I/O slowdown.${NC}"
        fi
        read -rp "Proceed with swap flush? [y/N] " confirm
        if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
            log_info "Aborted"
            exit 0
        fi
    fi

    echo

    # Step 1: Drop caches if needed
    if $need_cache_drop; then
        log_info "Syncing filesystems..."
        sync
        log_info "Dropping caches..."
        echo 3 > /proc/sys/vm/drop_caches
        
        # Recheck headroom
        mem_available=$(get_mem_kb MemAvailable)
        swap_used=$(( $(get_mem_kb SwapTotal) - $(get_mem_kb SwapFree) ))
        
        if (( mem_available < swap_used )); then
            log_error "Still insufficient RAM after dropping caches"
            log_error "Available: $(human_size "$mem_available"), Need: $(human_size "$swap_used")"
            log_error "Try closing some applications first"
            exit 1
        fi
        log_ok "Freed RAM: $(human_size "$mem_available") now available"
    fi

    # Step 2: Cycle swap
    log_info "Disabling swap (this may take a moment)..."
    if ! swapoff -a; then
        log_error "swapoff failed - system may be under extreme memory pressure"
        log_error "Try closing applications and retry"
        exit 1
    fi

    log_info "Re-enabling swap..."
    swapon -a

    echo
    log_ok "Swap flushed successfully!"
    echo
    log_info "Final state:"
    show_status
}

main "$@"
