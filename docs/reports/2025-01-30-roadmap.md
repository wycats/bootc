# Codebase Consistency Roadmap

**Date:** January 30, 2026  
**Status:** Draft  
**Branch:** feat/fetchbin-and-distrobox-capture

## Executive Summary

A comprehensive audit identified **16 total inconsistencies** between documentation and code:

- 6 from distrobox environment investigation
- 10 from codebase-wide recon

This roadmap prioritizes fixes by user impact.

---

## Tier 1: Immediate (Blocks Users)

These issues cause failures at runtime. Fix before merge.

### 1.1 `bootc-apply` calls non-existent `bkt dnf` command

| Field    | Value                                                                                      |
| -------- | ------------------------------------------------------------------------------------------ |
| Location | `scripts/bootc-apply` (lines 113-121)                                                      |
| Issue    | Script runs `bkt dnf sync --now`, but command is `bkt system` (no `dnf` subcommand exists) |
| Impact   | Boot-time failure — script crashes with "unknown command"                                  |
| Fix      | Change to `bkt system sync --now` or implement `bkt dnf` as alias                          |

### 1.3 Bootstrap calls wrong shim command (Known #4)

| Field    | Value                                                       |
| -------- | ----------------------------------------------------------- |
| Location | `scripts/bootc-bootstrap`                                   |
| Issue    | Calls `shim sync` but command is `bkt shim sync`            |
| Impact   | Host shims never generate; container→host delegation broken |
| Fix      | Change `shim` to `bkt shim`                                 |

### 1.4 Export location mismatch (Known #2)

| Field    | Value                                                                  |
| -------- | ---------------------------------------------------------------------- |
| Location | `docs/ARCHITECTURE.md`                                                 |
| Issue    | Claims exports land in `/usr/bin`, reality is `~/.local/bin/distrobox` |
| Impact   | Users look in wrong location for distrobox exports                     |
| Fix      | Update documentation to match manifest                                 |

---

## Tier 2: Short-Term (Causes Confusion)

These issues cause users to read docs and get wrong information.

### 2.1 Docs reference `bkt dnf` but command is `bkt system`

| Field     | Value                                                                                            |
| --------- | ------------------------------------------------------------------------------------------------ |
| Locations | `WORKFLOW.md`, `ARCHITECTURE.md`, `README.md`, `manifests/README.md`, `CURRENT.md`               |
| Issue     | Docs reference `bkt dnf`, `bkt dev dnf`, but actual commands are `bkt system`, `bkt dev install` |
| Fix       | Global find-replace: `bkt dnf` → `bkt system`                                                    |

### 2.2 Manifests README uses outdated command names

| Field    | Value                                             |
| -------- | ------------------------------------------------- |
| Location | `manifests/README.md`                             |
| Issue    | References `bkt flatpak list`, `bkt gnome apply`  |
| Reality  | Commands are `bkt flatpak`, `bkt gsettings apply` |
| Fix      | Update all command examples                       |

### 2.3 WORKFLOW examples wrong for `bkt apply`

| Field    | Value                                                                                                 |
| -------- | ----------------------------------------------------------------------------------------------------- |
| Location | `docs/WORKFLOW.md`                                                                                    |
| Issue    | Shows `bkt apply --exclude dnf` but `bkt apply` only supports `--prune-flatpaks`, `--prune-appimages` |
| Fix      | Rewrite apply examples                                                                                |

### 2.4 Delegation model outdated (Known #3)

| Field     | Value                                               |
| --------- | --------------------------------------------------- |
| Locations | `ARCHITECTURE.md`, `WORKFLOW.md`, `README.md`       |
| Issue     | Claim "all bkt commands work from host and toolbox" |
| Reality   | `bkt` is host-only                                  |
| Fix       | Update to reflect host-only model                   |

### 2.5 PATH policy conflict (Known #1)

| Field     | Value                                                       |
| --------- | ----------------------------------------------------------- |
| Locations | `VISION.md` vs `RFC-0017` vs `HANDOFF.md`                   |
| Issue     | VISION says "no inheritance," others say `PATH="...:$PATH"` |
| Fix       | Align all docs with VISION.md policy                        |

### 2.6 ARCHITECTURE marks `bkt status` as planned (Known #6 variant)

| Field    | Value                           |
| -------- | ------------------------------- |
| Location | `docs/ARCHITECTURE.md`          |
| Issue    | Shows `bkt status` as "Planned" |
| Reality  | Fully implemented               |
| Fix      | Update status table             |

### 2.7 Distrobox capture marked as planned (Known #6)

| Field    | Value                                |
| -------- | ------------------------------------ |
| Location | `docs/ARCHITECTURE.md`               |
| Issue    | Shows distrobox capture as "Planned" |
| Reality  | Implemented in current PR            |
| Fix      | Update status to "Implemented"       |

---

## Tier 3: Medium-Term (Polish)

These are annoyances but don't block workflows.

### 3.1 Host-shims schema incompatible with code

| Field    | Value                                                                                  |
| -------- | -------------------------------------------------------------------------------------- |
| Location | `schemas/host-shims.schema.json` vs `bkt/src/commands/shim.rs`                         |
| Issue    | Schema says `command` is a string; code expects tagged enum with `host`/`guest` fields |
| Fix      | Align schema with code                                                                 |

### 3.2 Schema generation omits active manifests

| Field    | Value                                                                                          |
| -------- | ---------------------------------------------------------------------------------------------- |
| Location | `bkt/src/commands/schema.rs`                                                                   |
| Issue    | `bkt schema list` doesn't include `system-packages`, `toolbox-packages`, `appimage-apps`, etc. |
| Fix      | Add all manifest types                                                                         |

### 3.3 Manifest schema drift in RFC examples (Known #5)

| Field    | Value                                                          |
| -------- | -------------------------------------------------------------- |
| Location | `docs/rfcs/0017-distrobox-integration.md`                      |
| Issue    | Uses `exported_bins`, actual schema uses `bins.from`/`bins.to` |
| Fix      | Update RFC examples                                            |

### 3.4 Repo config path/format mismatch

| Field    | Value                                                                    |
| -------- | ------------------------------------------------------------------------ |
| Location | `README.md` vs `bkt/src/repo.rs`                                         |
| Issue    | Docs say `~/.config/bkt/repos.json`, code reads `repo.json` in workspace |
| Fix      | Pick canonical location, update docs                                     |

### 3.5 CURRENT.md contradicts live capture

| Field    | Value                                  |
| -------- | -------------------------------------- |
| Location | `CURRENT.md`                           |
| Issue    | Says distrobox command only reads JSON |
| Reality  | Supports `--live` capture              |
| Fix      | Update CURRENT.md                      |

### 3.6 Test coverage gaps

| Field                  | Value                                                                                                                                         |
| ---------------------- | --------------------------------------------------------------------------------------------------------------------------------------------- |
| Location               | `bkt/tests/`                                                                                                                                  |
| Issue                  | Many commands lack test coverage                                                                                                              |
| Commands needing tests | apply, system, admin, doctor, status, distrobox, appimage, fetchbin, homebrew, upstream, build-info, containerfile, schema, completions, base |
| Fix                    | Add integration tests per command                                                                                                             |

---

## Implementation Plan

### Phase 1: Critical Fixes (Before PR Merge)

```
[ ] 1. Fix scripts/bootc-apply: bkt dnf → bkt system
[ ] 2. Fix scripts/bootc-bootstrap to use `bkt shim sync`
[ ] 3. Fix ARCHITECTURE.md export location
```

### Phase 2: Documentation Cleanup (Next Week)

```
[ ] 4. Global rename: bkt dnf → bkt system
[ ] 5. Global rename: bkt dev dnf → bkt dev install
[ ] 6. Update manifests/README.md command examples
[ ] 7. Rewrite WORKFLOW.md apply examples
[ ] 8. Update delegation model docs
[ ] 9. Align PATH policy across all docs
[ ] 10. Mark bkt status as implemented
[ ] 11. Mark distrobox capture as implemented
```

### Phase 3: Schema & Code Alignment (This Month)

```
[ ] 12. Fix host-shims schema
[ ] 13. Add missing manifests to schema command
[ ] 14. Update RFC-0017 examples
[ ] 15. Resolve repo config path
[ ] 16. Update CURRENT.md for live capture
```

### Phase 4: Testing (Ongoing)

```
[ ] 17. Add CLI tests for each command
[ ] 18. Add manifest validation tests
[ ] 19. Add doctor health check tests
```

---

## Risk Matrix

| Issue                                 | Likelihood of User Hit  | Severity | Priority |
| ------------------------------------- | ----------------------- | -------- | -------- |
| bootc-apply `bkt dnf` (doesn't exist) | High (boot time)        | Critical | P0       |
| Bootstrap shim command                | High (first login)      | Critical | P0       |
| bkt dnf → bkt system in docs          | High (following docs)   | Medium   | P1       |
| Delegation model claims               | Medium (advanced users) | Low      | P2       |
| Schema mismatches                     | Low (developers only)   | Low      | P3       |

---

## Appendix: Issue Cross-Reference

| ID  | Source    | Summary                                                     |
| --- | --------- | ----------------------------------------------------------- |
| K1  | Env Audit | PATH policy conflict                                        |
| K2  | Env Audit | Export location mismatch                                    |
| K3  | Env Audit | Delegation model outdated                                   |
| K4  | Env Audit | Bootstrap calls wrong shim command                          |
| K5  | Env Audit | Manifest schema drift in RFC                                |
| K6  | Env Audit | Distrobox capture marked as planned                         |
| N1  | Recon     | bootc-apply calls non-existent `bkt dnf`                    |
| N2  | Recon     | Docs use bkt dnf/dev dnf (should be bkt system/dev install) |
| N3  | Recon     | bkt apply --exclude dnf unsupported                         |
| N4  | Recon     | Manifests README outdated commands                          |
| N5  | Recon     | Host-shims schema incompatible with code                    |
| N6  | Recon     | Schema generation omits manifests                           |
| N7  | Recon     | CURRENT.md contradicts live capture                         |
| N8  | Recon     | ARCHITECTURE marks status as planned                        |
| N9  | Recon     | Repo config path mismatch                                   |
