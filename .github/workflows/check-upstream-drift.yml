name: Check Upstream Drift

on:
  schedule:
    # Run weekly on Sunday at midnight UTC
    - cron: "0 0 * * 0"
  workflow_dispatch:
    # Manual trigger for ad-hoc drift checks

env:
  CARGO_TERM_COLOR: always

jobs:
  check-stable:
    name: Check :stable
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/ublue-os/bazzite-gnome:stable
      options: --privileged
    timeout-minutes: 30

    steps:
      - name: Install build dependencies
        run: |
          dnf install -y rust cargo git

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: bkt -> target

      - name: Build bkt
        working-directory: bkt
        run: cargo build --release

      - name: Check drift against :stable
        id: drift-stable
        continue-on-error: true
        run: |
          echo "Checking base image assumptions against :stable..."
          ./bkt/target/release/bkt base verify 2>&1 | tee drift-stable.txt
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Upload drift report
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-stable
          path: drift-stable.txt
          retention-days: 30

      - name: Create issue on drift detected
        if: steps.drift-stable.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('drift-stable.txt', 'utf8');

            // Check if an open issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['drift', 'base-image']
            });

            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `## Weekly Drift Check Update\n\n**Date:** ${new Date().toISOString()}\n**Image:** \`:stable\`\n\n\`\`\`\n${report}\n\`\`\``
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '⚠️ Base Image Drift Detected (:stable)',
                body: `## Base Image Drift Detected\n\nThe weekly drift check has detected that the base image no longer matches our assumptions.\n\n**Image:** \`ghcr.io/ublue-os/bazzite-gnome:stable\`\n**Date:** ${new Date().toISOString()}\n\n### Report\n\n\`\`\`\n${report}\n\`\`\`\n\n### Next Steps\n\n1. Review which packages are missing\n2. Update \`manifests/base-image-assumptions.json\` if assumptions should change\n3. Update Containerfile to add missing packages if they're still needed\n4. Close this issue once resolved`,
                labels: ['drift', 'base-image']
              });
            }

  check-latest:
    name: Check :latest (informational)
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/ublue-os/bazzite-gnome:latest
      options: --privileged
    timeout-minutes: 30

    steps:
      - name: Install build dependencies
        run: |
          dnf install -y rust cargo git

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: bkt -> target

      - name: Build bkt
        working-directory: bkt
        run: cargo build --release

      - name: Check drift against :latest (informational)
        continue-on-error: true
        run: |
          echo "Checking base image assumptions against :latest..."
          echo "Note: This is informational only - :latest may have intentional changes"
          ./bkt/target/release/bkt base verify 2>&1 | tee drift-latest.txt || true

      - name: Upload drift report
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-latest
          path: drift-latest.txt
          retention-days: 30
